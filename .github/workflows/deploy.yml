name: Deploy PHP Telegram Bot

on:
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    env:
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      ALLOWED_USER_IDS: ${{ secrets.ALLOWED_USER_IDS }}
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
      FTP_PATH: ${{ secrets.FTP_PATH }}

    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: âš™ï¸ Set up PHP with Composer
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.1'
        extensions: curl, mbstring, gd, dom, fileinfo, json
        tools: composer

    - name: ğŸ“¦ Install QRCode library (Composer)
      run: composer require endroid/qr-code

    - name: ğŸ§© Prepare QRCode classes for no-composer hosting
      run: php prepare_qrcode.php

    - name: ğŸ” Inject secrets into .env
      run: |
        echo "BOT_TOKEN=${BOT_TOKEN}" >> .env
        echo "ALLOWED_USER_IDS=${ALLOWED_USER_IDS}" >> .env

    - name: ğŸ—ï¸ Build project
      run: python3 build.py

    - name: ğŸš€ Upload to FTP
      uses: SamKirkland/FTP-Deploy-Action@v4.0.0
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./build/
        server-dir: ${{ secrets.FTP_PATH }}/
